services:
  drupal:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: drupal-web
    environment:
      - PHP_VERSION=${PHP_VERSION:-8.3}
      - XDEBUG_MODE=${XDEBUG_MODE:-off}
      - VIRTUAL_HOST=*.${DOMAIN_SUFFIX},${DOMAIN_SUFFIX}
      - VIRTUAL_PORT=80
      - DOMAIN_SUFFIX=${DOMAIN_SUFFIX}
    volumes:
      - drupal_files:/var/www/html/web/sites/default/files
      - drupal_private:/var/www/html/private
      - ./:/var/www/html
      - ./web/sites:/var/www/html/web/sites
    depends_on:
      - mysql
    networks:
      - drupal-network
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  drupal-apex:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: drupal-apex
    environment:
      - PHP_VERSION=${PHP_VERSION:-8.3}
      - XDEBUG_MODE=${XDEBUG_MODE:-off}
      - VIRTUAL_HOST=${DOMAIN_SUFFIX}
      - VIRTUAL_PORT=80
      - DOMAIN_SUFFIX=${DOMAIN_SUFFIX}
    volumes:
      - drupal_files:/var/www/html/web/sites/default/files
      - drupal_private:/var/www/html/private
      - ./:/var/www/html
      - ./web/sites:/var/www/html/web/sites
    depends_on:
      - mysql
    networks:
      - drupal-network
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  mysql:
    image: mariadb:11.4
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-drupal}
      - MYSQL_USER=${MYSQL_USER:-drupal}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MARIADB_AUTO_UPGRADE=1
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql-init.sql:/docker-entrypoint-initdb.d/01-permissions.sql:ro
    networks:
      - drupal-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  nginx:
    image: nginxproxy/nginx-proxy
    container_name: nginx-proxy
    labels:
      - "com.github.nginx-proxy.nginx"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - nginx_certs:/etc/nginx/certs
      - nginx_vhost:/etc/nginx/vhost.d
      - nginx_html:/usr/share/nginx/html
    networks:
      - drupal-network
    restart: unless-stopped

  letsencrypt:
    image: nginxproxy/acme-companion
    container_name: nginx-letsencrypt
    environment:
      - CF_Token=${CF_Token:-}
      - CF_Account_ID=${CF_Account_ID:-}
      - CF_Zone_ID=${CF_Zone_ID:-}
      - ACMESH_DNS=dns_cf
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL}
      - NGINX_PROXY_CONTAINER=nginx-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - nginx_certs:/etc/nginx/certs
      - nginx_vhost:/etc/nginx/vhost.d
      - nginx_html:/usr/share/nginx/html
      - nginx_acme:/etc/acme.sh
      - ./scripts/host/ssl-setup.sh:/app/ssl-setup.sh:ro
      - ./scripts/host/ssl-renew.sh:/app/ssl-renew.sh:ro
    depends_on:
      - nginx
    networks:
      - drupal-network
    restart: unless-stopped
    command: ["/bin/sh", "-c", "/app/ssl-setup.sh && /app/start.sh"]

volumes:
  drupal_files:
  drupal_private:
  mysql_data:
  nginx_certs:
  nginx_vhost:
  nginx_html:
  nginx_acme:

networks:
  drupal-network:
    driver: bridge
