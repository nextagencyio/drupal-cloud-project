#!/bin/bash

## Description: Install Drupal Cloud on Pantheon site
## Usage: pantheon-install [site-id]
## Example: "ddev pantheon-install drupal-cloud"

# Check if terminus is available
if ! command -v terminus &> /dev/null; then
    echo "Error: Terminus CLI is not installed or not in PATH"
    echo "Install it from: https://pantheon.io/docs/terminus/install"
    exit 1
fi

# Check if site ID is provided
if [ -z "$1" ]; then
    echo "Error: Site ID is required"
    echo "Usage: ddev pantheon-install [site-id]"
    echo "Example: ddev pantheon-install drupal-cloud"
    exit 1
fi

SITE_ID="$1"
ENV="${2:-dev}"

echo "=================================================="
echo "Drupal Cloud Pantheon Installation Starting..."
echo "Site: $SITE_ID"
echo "Environment: $ENV"
echo "=================================================="

# Check if site exists
if ! terminus site:info "$SITE_ID" &> /dev/null; then
    echo "Error: Site '$SITE_ID' not found or you don't have access"
    exit 1
fi

# Step 1: Install locally with DDEV
echo ""
echo "Step 1: Installing Drupal locally with DDEV..."
echo "=================================================="
if ! ddev install; then
    echo "Error: Local installation failed"
    exit 1
fi

echo ""
echo "âœ… Local installation complete!"

# Step 2: Export local database
echo ""
echo "Step 2: Exporting local database..."
echo "=================================================="
DB_DUMP="/tmp/drupal-cloud-${SITE_ID}.sql.gz"
if ! ddev export-db --gzip --file="$DB_DUMP"; then
    echo "Error: Database export failed"
    exit 1
fi

echo "âœ… Database exported to: $DB_DUMP"

# Step 3: Set Pantheon to SFTP mode
echo ""
echo "Step 3: Setting Pantheon to SFTP mode..."
echo "=================================================="
terminus connection:set "$SITE_ID.$ENV" sftp

# Step 4: Import database to Pantheon
echo ""
echo "Step 4: Importing database to Pantheon..."
echo "=================================================="
if ! terminus import:database "$SITE_ID.$ENV" "$DB_DUMP"; then
    echo "Error: Database import failed"
    exit 1
fi

echo "âœ… Database imported to Pantheon!"

# Step 5: Clear caches on Pantheon (skip if it fails due to MemoryBackend bug)
echo ""
echo "Step 5: Clearing caches on Pantheon..."
echo "=================================================="
terminus drush "$SITE_ID.$ENV" -- cache:rebuild || echo "âš ï¸  Cache rebuild failed (known Pantheon bug), but site should work"

# Step 6: Set connection mode back to git
echo ""
echo "Step 6: Setting connection mode back to git..."
echo "=================================================="
terminus connection:set "$SITE_ID.$ENV" git

# Clean up local database dump
rm -f "$DB_DUMP"

# Generate login link (may fail due to MemoryBackend bug)
echo ""
echo "Generating admin login link..."
LOGIN_URL=$(terminus drush "$SITE_ID.$ENV" -- uli 2>/dev/null || echo "Login link generation failed")

# Get site URL
SITE_URL=$(terminus env:view "$SITE_ID.$ENV" --print)

echo "=================================================="
echo "âœ… Drupal Cloud installation completed successfully!"
echo "=================================================="
echo ""
echo "ğŸŒ Site URL: $SITE_URL"
echo "ğŸ‘¤ Admin login: $LOGIN_URL"
echo "ğŸ“‹ Admin credentials: admin/admin"
echo ""
echo "ğŸ”§ Available APIs:"
echo "   - GraphQL: ${SITE_URL}graphql"
echo "   - JSON:API: ${SITE_URL}jsonapi"
echo ""
echo "Happy Drupaling on Pantheon! ğŸš€"
