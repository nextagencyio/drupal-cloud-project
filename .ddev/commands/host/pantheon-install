#!/bin/bash

## Description: Install Drupal Cloud on Pantheon site using existing config
## Usage: pantheon-install [site-id]
## Example: "ddev pantheon-install drupal-cloud"

# Check if terminus is available
if ! command -v terminus &> /dev/null; then
    echo "Error: Terminus CLI is not installed or not in PATH"
    echo "Install it from: https://pantheon.io/docs/terminus/install"
    exit 1
fi

# Check if site ID is provided
if [ -z "$1" ]; then
    echo "Error: Site ID is required"
    echo "Usage: ddev pantheon-install [site-id]"
    echo "Example: ddev pantheon-install drupal-cloud"
    exit 1
fi

SITE_ID="$1"
ENV="${2:-dev}"

echo "=================================================="
echo "Drupal Cloud Pantheon Installation Starting..."
echo "Site: $SITE_ID"
echo "Environment: $ENV"
echo "Using --existing-config installation method"
echo "=================================================="

# Check if site exists
if ! terminus site:info "$SITE_ID" &> /dev/null; then
    echo "Error: Site '$SITE_ID' not found or you don't have access"
    exit 1
fi

# Step 1: Ensure Pantheon is in git mode
echo ""
echo "Step 1: Ensuring Pantheon is in git mode..."
echo "=================================================="
terminus connection:set "$SITE_ID.$ENV" git

# Step 2: Install Drupal with existing config
echo ""
echo "Step 2: Installing Drupal from existing configuration..."
echo "=================================================="
if ! terminus drush "$SITE_ID.$ENV" -- site:install --existing-config -y; then
    echo "Error: Site installation with existing config failed"
    exit 1
fi

echo "âœ… Drupal installed from existing configuration!"

# Step 3: Run consumers-next script
echo ""
echo "Step 3: Setting up OAuth consumers..."
echo "=================================================="
terminus drush "$SITE_ID.$ENV" -- scr scripts/consumers-next.php || echo "âš ï¸  OAuth setup failed, you may need to run this manually"

# Generate login link (may fail due to MemoryBackend bug)
echo ""
echo "Generating admin login link..."
LOGIN_URL=$(terminus drush "$SITE_ID.$ENV" -- uli 2>/dev/null || echo "Login link generation failed")

# Get site URL
SITE_URL=$(terminus env:view "$SITE_ID.$ENV" --print)

echo "=================================================="
echo "âœ… Drupal Cloud installation completed successfully!"
echo "=================================================="
echo ""
echo "ğŸŒ Site URL: $SITE_URL"
echo "ğŸ‘¤ Admin login: $LOGIN_URL"
echo "ğŸ“‹ Admin credentials: admin/admin"
echo ""
echo "ğŸ”§ Available APIs:"
echo "   - GraphQL: ${SITE_URL}graphql"
echo "   - JSON:API: ${SITE_URL}jsonapi"
echo ""
echo "Happy Drupaling on Pantheon! ğŸš€"
