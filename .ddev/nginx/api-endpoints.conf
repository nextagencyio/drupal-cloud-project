# Custom configuration for Drupal API endpoints
# This configuration handles both static API files and Drupal routing

# Handle static API files (like create-site.php)
location ~ ^/api/([^/]+\.php)$ {
    alias /var/www/html/api/;
    
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_pass unix:/run/php-fpm.sock;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    
    # Set the script filename to point to the API directory
    fastcgi_param SCRIPT_FILENAME /var/www/html/api/$1;
    fastcgi_param SCRIPT_NAME /api/$1;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_param DOCUMENT_URI $document_uri;
    fastcgi_param DOCUMENT_ROOT /var/www/html;
    
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_intercept_errors off;
    fastcgi_read_timeout 10m;
    fastcgi_param SERVER_NAME $host;
    fastcgi_param HTTPS $fcgi_https;
    
    # Pass the X-Accel-* headers
    fastcgi_pass_header "X-Accel-Buffering";
    fastcgi_pass_header "X-Accel-Charset";
    fastcgi_pass_header "X-Accel-Expires";
    fastcgi_pass_header "X-Accel-Limit-Rate";
    fastcgi_pass_header "X-Accel-Redirect";
}

# Handle Drupal API routes (like /api/dcloud/usage)
location ~ ^/api/dcloud/ {
    try_files $uri /index.php?$query_string;
}